name: Run Branch Tests with Regression Detection

on:
  workflow_call:
    inputs:
      target_branch:
        description: "Target branch to compare against (e.g., main)."
        required: true
        type: string
      python-version:
        description: "Python version for pytest."
        required: false
        type: string
        default: "3.10"
      node-version:
        description: "Node.js version for Jest/Mocha."
        required: false
        type: string
        default: "18"
      runs_on:
        description: "Runner label."
        required: false
        type: string
        default: '["self-hosted", "multithreaded"]'
      parallel_workers:
        description: "Number of parallel workers. Leave empty for auto-detect (6 for multithreaded, 1 for singlethreaded). Use 'auto' for cgroup-aware CPU count."
        required: false
        type: string
        default: ""
      jest-command:
        description: "Base command used to invoke Jest."
        required: false
        type: string
        default: "npx jest"
      jest-extra-args:
        description: "Additional arguments to pass to Jest."
        required: false
        type: string
        default: ""
      mocha-command:
        description: "Base command used to invoke Mocha."
        required: false
        type: string
        default: "npx mocha"
      mocha-extra-args:
        description: "Additional arguments to pass to Mocha."
        required: false
        type: string
        default: ""
      working-directory:
        description: "Directory where JS test commands should be executed."
        required: false
        type: string
        default: "."
    secrets:
      DISCORD_WEBHOOK_URL:
        required: false
      DISCORD_USER_MAP:
        required: false
    outputs:
      has_regressions:
        description: "Whether regressions were detected (any framework)"
        value: ${{ jobs.aggregate-results.outputs.has_regressions }}
      regression_count:
        description: "Total number of regressions (all frameworks)"
        value: ${{ jobs.aggregate-results.outputs.regression_count }}

jobs:
  # Detect which test frameworks are present
  detect-frameworks:
    runs-on: ${{ fromJSON(inputs.runs_on) }}
    outputs:
      has_pytest: ${{ steps.detect.outputs.has_pytest }}
      has_jest: ${{ steps.detect.outputs.has_jest }}
      has_mocha: ${{ steps.detect.outputs.has_mocha }}
    steps:
      - uses: actions/checkout@v4.2.2
      - name: Detect test frameworks
        id: detect
        run: |
          # Detect pytest
          if [ -f "pyproject.toml" ] || [ -f "setup.py" ] || [ -f "requirements.txt" ] || find . -name "test_*.py" -o -name "*_test.py" 2>/dev/null | head -1 | grep -q .; then
            echo "has_pytest=true" >> $GITHUB_OUTPUT
            echo "Detected: pytest"
          else
            echo "has_pytest=false" >> $GITHUB_OUTPUT
          fi

          # Detect Jest
          HAS_JEST="false"
          if [ -f "package.json" ]; then
            # Check for jest in dependencies or devDependencies
            if grep -q '"jest"' package.json 2>/dev/null; then
              HAS_JEST="true"
            fi
            # Check for jest config files
            if [ -f "jest.config.js" ] || [ -f "jest.config.ts" ] || [ -f "jest.config.mjs" ] || [ -f "jest.config.cjs" ] || [ -f "jest.config.json" ]; then
              HAS_JEST="true"
            fi
            # Check for jest section in package.json
            if grep -q '"jest":' package.json 2>/dev/null; then
              HAS_JEST="true"
            fi
          fi
          echo "has_jest=$HAS_JEST" >> $GITHUB_OUTPUT
          if [ "$HAS_JEST" = "true" ]; then
            echo "Detected: Jest"
          fi

          # Detect Mocha
          HAS_MOCHA="false"
          if [ -f "package.json" ]; then
            # Check for mocha in dependencies or devDependencies
            if grep -q '"mocha"' package.json 2>/dev/null; then
              HAS_MOCHA="true"
            fi
            # Check for mocha config files
            if [ -f ".mocharc.js" ] || [ -f ".mocharc.json" ] || [ -f ".mocharc.yml" ] || [ -f ".mocharc.yaml" ] || [ -f ".mocharc.cjs" ] || [ -f ".mocharc.mjs" ]; then
              HAS_MOCHA="true"
            fi
            # Check for mocha section in package.json
            if grep -q '"mocha":' package.json 2>/dev/null; then
              HAS_MOCHA="true"
            fi
          fi
          echo "has_mocha=$HAS_MOCHA" >> $GITHUB_OUTPUT
          if [ "$HAS_MOCHA" = "true" ]; then
            echo "Detected: Mocha"
          fi

  # ==================== PYTEST ====================
  # Test source branch (always fresh, no caching)
  pytest-source:
    needs: detect-frameworks
    if: needs.detect-frameworks.outputs.has_pytest == 'true'
    uses: ./.github/workflows/test-py-pytest.yml
    with:
      ref: ""  # Default checkout = PR branch
      python-version: ${{ inputs.python-version }}
      runs_on: ${{ inputs.runs_on }}
      artifact_name: pytest_source_${{ github.event.pull_request.number || github.run_id }}
      parallel_workers: ${{ inputs.parallel_workers }}

  # Test target branch for pytest
  pytest-target:
    needs: detect-frameworks
    if: needs.detect-frameworks.outputs.has_pytest == 'true'
    uses: ./.github/workflows/test-py-pytest.yml
    with:
      ref: ${{ inputs.target_branch }}
      python-version: ${{ inputs.python-version }}
      runs_on: ${{ inputs.runs_on }}
      artifact_name: pytest_target_${{ github.event.pull_request.number || github.run_id }}
      parallel_workers: ${{ inputs.parallel_workers }}

  # Compare pytest results
  pytest-compare:
    needs: [detect-frameworks, pytest-source, pytest-target]
    if: always() && needs.detect-frameworks.outputs.has_pytest == 'true' && needs.pytest-source.result == 'success'
    uses: ./.github/workflows/regression-test.yml
    with:
      runs_on: ${{ inputs.runs_on }}
      baseline_label: ${{ inputs.target_branch }}
      baseline_results_artifact: pytest_target_${{ github.event.pull_request.number || github.run_id }}
      baseline_results_filename: test_data.json
      current_label: ${{ github.head_ref || github.ref_name }}
      current_results_artifact: pytest_source_${{ github.event.pull_request.number || github.run_id }}
      current_results_filename: test_data.json
      baseline_passed: ${{ needs.pytest-target.outputs.passed }}
      baseline_total: ${{ needs.pytest-target.outputs.total }}
      baseline_percentage: ${{ needs.pytest-target.outputs.percentage }}
      current_passed: ${{ needs.pytest-source.outputs.passed }}
      current_total: ${{ needs.pytest-source.outputs.total }}
      current_percentage: ${{ needs.pytest-source.outputs.percentage }}
      baseline_collection_errors: ${{ needs.pytest-target.outputs.collection_errors }}
      baseline_no_tests_found: ${{ needs.pytest-target.outputs.no_tests_found }}
      current_collection_errors: ${{ needs.pytest-source.outputs.collection_errors }}
      current_no_tests_found: ${{ needs.pytest-source.outputs.no_tests_found }}
      artifact_name: regression_pytest_${{ github.event.pull_request.number || github.run_id }}

  # ==================== JEST ====================
  # Test source branch with Jest
  jest-source:
    needs: detect-frameworks
    if: needs.detect-frameworks.outputs.has_jest == 'true'
    uses: ./.github/workflows/test-js-jest.yml
    with:
      ref: ""  # Default checkout = PR branch
      node-version: ${{ inputs.node-version }}
      runs_on: ${{ inputs.runs_on }}
      artifact_name: jest_source_${{ github.event.pull_request.number || github.run_id }}
      parallel_workers: ${{ inputs.parallel_workers }}
      jest-command: ${{ inputs.jest-command }}
      jest-extra-args: ${{ inputs.jest-extra-args }}
      working-directory: ${{ inputs.working-directory }}

  # Test target branch with Jest
  jest-target:
    needs: detect-frameworks
    if: needs.detect-frameworks.outputs.has_jest == 'true'
    uses: ./.github/workflows/test-js-jest.yml
    with:
      ref: ${{ inputs.target_branch }}
      node-version: ${{ inputs.node-version }}
      runs_on: ${{ inputs.runs_on }}
      artifact_name: jest_target_${{ github.event.pull_request.number || github.run_id }}
      parallel_workers: ${{ inputs.parallel_workers }}
      jest-command: ${{ inputs.jest-command }}
      jest-extra-args: ${{ inputs.jest-extra-args }}
      working-directory: ${{ inputs.working-directory }}

  # Compare Jest results
  jest-compare:
    needs: [detect-frameworks, jest-source, jest-target]
    if: always() && needs.detect-frameworks.outputs.has_jest == 'true' && needs.jest-source.result == 'success'
    uses: ./.github/workflows/regression-test.yml
    with:
      runs_on: ${{ inputs.runs_on }}
      baseline_label: ${{ inputs.target_branch }}
      baseline_results_artifact: jest_target_${{ github.event.pull_request.number || github.run_id }}
      baseline_results_filename: test_data.json
      current_label: ${{ github.head_ref || github.ref_name }}
      current_results_artifact: jest_source_${{ github.event.pull_request.number || github.run_id }}
      current_results_filename: test_data.json
      baseline_passed: ${{ needs.jest-target.outputs.passed }}
      baseline_total: ${{ needs.jest-target.outputs.total }}
      baseline_percentage: ${{ needs.jest-target.outputs.percentage }}
      current_passed: ${{ needs.jest-source.outputs.passed }}
      current_total: ${{ needs.jest-source.outputs.total }}
      current_percentage: ${{ needs.jest-source.outputs.percentage }}
      baseline_collection_errors: ${{ needs.jest-target.outputs.collection_errors }}
      baseline_no_tests_found: ${{ needs.jest-target.outputs.no_tests_found }}
      current_collection_errors: ${{ needs.jest-source.outputs.collection_errors }}
      current_no_tests_found: ${{ needs.jest-source.outputs.no_tests_found }}
      artifact_name: regression_jest_${{ github.event.pull_request.number || github.run_id }}

  # ==================== MOCHA ====================
  # Test source branch with Mocha
  mocha-source:
    needs: detect-frameworks
    if: needs.detect-frameworks.outputs.has_mocha == 'true'
    uses: ./.github/workflows/test-js-mocha.yml
    with:
      ref: ""  # Default checkout = PR branch
      node-version: ${{ inputs.node-version }}
      runs_on: ${{ inputs.runs_on }}
      artifact_name: mocha_source_${{ github.event.pull_request.number || github.run_id }}
      parallel_workers: ${{ inputs.parallel_workers }}
      mocha-command: ${{ inputs.mocha-command }}
      mocha-extra-args: ${{ inputs.mocha-extra-args }}
      working-directory: ${{ inputs.working-directory }}

  # Test target branch with Mocha
  mocha-target:
    needs: detect-frameworks
    if: needs.detect-frameworks.outputs.has_mocha == 'true'
    uses: ./.github/workflows/test-js-mocha.yml
    with:
      ref: ${{ inputs.target_branch }}
      node-version: ${{ inputs.node-version }}
      runs_on: ${{ inputs.runs_on }}
      artifact_name: mocha_target_${{ github.event.pull_request.number || github.run_id }}
      parallel_workers: ${{ inputs.parallel_workers }}
      mocha-command: ${{ inputs.mocha-command }}
      mocha-extra-args: ${{ inputs.mocha-extra-args }}
      working-directory: ${{ inputs.working-directory }}

  # Compare Mocha results
  mocha-compare:
    needs: [detect-frameworks, mocha-source, mocha-target]
    if: always() && needs.detect-frameworks.outputs.has_mocha == 'true' && needs.mocha-source.result == 'success'
    uses: ./.github/workflows/regression-test.yml
    with:
      runs_on: ${{ inputs.runs_on }}
      baseline_label: ${{ inputs.target_branch }}
      baseline_results_artifact: mocha_target_${{ github.event.pull_request.number || github.run_id }}
      baseline_results_filename: test_data.json
      current_label: ${{ github.head_ref || github.ref_name }}
      current_results_artifact: mocha_source_${{ github.event.pull_request.number || github.run_id }}
      current_results_filename: test_data.json
      baseline_passed: ${{ needs.mocha-target.outputs.passed }}
      baseline_total: ${{ needs.mocha-target.outputs.total }}
      baseline_percentage: ${{ needs.mocha-target.outputs.percentage }}
      current_passed: ${{ needs.mocha-source.outputs.passed }}
      current_total: ${{ needs.mocha-source.outputs.total }}
      current_percentage: ${{ needs.mocha-source.outputs.percentage }}
      baseline_collection_errors: ${{ needs.mocha-target.outputs.collection_errors }}
      baseline_no_tests_found: ${{ needs.mocha-target.outputs.no_tests_found }}
      current_collection_errors: ${{ needs.mocha-source.outputs.collection_errors }}
      current_no_tests_found: ${{ needs.mocha-source.outputs.no_tests_found }}
      artifact_name: regression_mocha_${{ github.event.pull_request.number || github.run_id }}

  # ==================== AGGREGATE RESULTS ====================
  aggregate-results:
    needs: [detect-frameworks, pytest-compare, jest-compare, mocha-compare]
    if: always()
    runs-on: ${{ fromJSON(inputs.runs_on) }}
    outputs:
      has_regressions: ${{ steps.aggregate.outputs.has_regressions }}
      regression_count: ${{ steps.aggregate.outputs.regression_count }}
    steps:
      - name: Aggregate regression results
        id: aggregate
        run: |
          TOTAL_REGRESSIONS=0
          HAS_REGRESSIONS="false"

          # Check pytest
          if [ "${{ needs.detect-frameworks.outputs.has_pytest }}" == "true" ]; then
            PYTEST_REGRESSIONS="${{ needs.pytest-compare.outputs.regression_count || '0' }}"
            if [ "${{ needs.pytest-compare.outputs.has_regressions }}" == "true" ]; then
              HAS_REGRESSIONS="true"
              TOTAL_REGRESSIONS=$((TOTAL_REGRESSIONS + PYTEST_REGRESSIONS))
              echo "Pytest regressions: $PYTEST_REGRESSIONS"
            fi
          fi

          # Check Jest
          if [ "${{ needs.detect-frameworks.outputs.has_jest }}" == "true" ]; then
            JEST_REGRESSIONS="${{ needs.jest-compare.outputs.regression_count || '0' }}"
            if [ "${{ needs.jest-compare.outputs.has_regressions }}" == "true" ]; then
              HAS_REGRESSIONS="true"
              TOTAL_REGRESSIONS=$((TOTAL_REGRESSIONS + JEST_REGRESSIONS))
              echo "Jest regressions: $JEST_REGRESSIONS"
            fi
          fi

          # Check Mocha
          if [ "${{ needs.detect-frameworks.outputs.has_mocha }}" == "true" ]; then
            MOCHA_REGRESSIONS="${{ needs.mocha-compare.outputs.regression_count || '0' }}"
            if [ "${{ needs.mocha-compare.outputs.has_regressions }}" == "true" ]; then
              HAS_REGRESSIONS="true"
              TOTAL_REGRESSIONS=$((TOTAL_REGRESSIONS + MOCHA_REGRESSIONS))
              echo "Mocha regressions: $MOCHA_REGRESSIONS"
            fi
          fi

          echo "has_regressions=$HAS_REGRESSIONS" >> $GITHUB_OUTPUT
          echo "regression_count=$TOTAL_REGRESSIONS" >> $GITHUB_OUTPUT
          echo "Total regressions across all frameworks: $TOTAL_REGRESSIONS"

  # ==================== NOTIFICATIONS ====================
  notify:
    needs: [detect-frameworks, pytest-source, pytest-target, pytest-compare, jest-source, jest-target, jest-compare, mocha-source, mocha-target, mocha-compare, aggregate-results]
    if: always() && needs.aggregate-results.outputs.has_regressions == 'true'
    runs-on: ${{ fromJSON(inputs.runs_on) }}
    steps:
      - name: Send notification
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -z "$WEBHOOK" ]; then
            echo "No Discord webhook configured, skipping notification"
            exit 0
          fi

          MSG="**Test Regression Alert**\n"
          MSG+="PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}\n"
          MSG+="\`${{ github.head_ref }}\` -> \`${{ inputs.target_branch }}\`\n\n"

          # Pytest results
          if [ "${{ needs.detect-frameworks.outputs.has_pytest }}" == "true" ]; then
            MSG+="**Pytest:**\n"
            MSG+="  Source: ${{ needs.pytest-source.outputs.passed }}/${{ needs.pytest-source.outputs.total }}\n"
            MSG+="  Target: ${{ needs.pytest-target.outputs.passed }}/${{ needs.pytest-target.outputs.total }}\n"
            if [ "${{ needs.pytest-compare.outputs.has_regressions }}" == "true" ]; then
              MSG+="  Regressions: ${{ needs.pytest-compare.outputs.regression_count }}\n"
            fi
            MSG+="\n"
          fi

          # Jest results
          if [ "${{ needs.detect-frameworks.outputs.has_jest }}" == "true" ]; then
            MSG+="**Jest:**\n"
            MSG+="  Source: ${{ needs.jest-source.outputs.passed }}/${{ needs.jest-source.outputs.total }}\n"
            MSG+="  Target: ${{ needs.jest-target.outputs.passed }}/${{ needs.jest-target.outputs.total }}\n"
            if [ "${{ needs.jest-compare.outputs.has_regressions }}" == "true" ]; then
              MSG+="  Regressions: ${{ needs.jest-compare.outputs.regression_count }}\n"
            fi
            MSG+="\n"
          fi

          # Mocha results
          if [ "${{ needs.detect-frameworks.outputs.has_mocha }}" == "true" ]; then
            MSG+="**Mocha:**\n"
            MSG+="  Source: ${{ needs.mocha-source.outputs.passed }}/${{ needs.mocha-source.outputs.total }}\n"
            MSG+="  Target: ${{ needs.mocha-target.outputs.passed }}/${{ needs.mocha-target.outputs.total }}\n"
            if [ "${{ needs.mocha-compare.outputs.has_regressions }}" == "true" ]; then
              MSG+="  Regressions: ${{ needs.mocha-compare.outputs.regression_count }}\n"
            fi
            MSG+="\n"
          fi

          MSG+="Total Regressions: ${{ needs.aggregate-results.outputs.regression_count }}\n\n"
          MSG+="[View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})"

          curl -s -H "Content-Type: application/json" \
            -d "{\"content\": \"$(echo -e "$MSG")\"}" \
            "$WEBHOOK" || true
