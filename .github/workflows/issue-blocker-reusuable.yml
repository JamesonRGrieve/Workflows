# .github/workflows/issue-blocker.yml

name: "Reusable Issue Blocker Workflow"

on:
  workflow_dispatch:
  workflow_call:

permissions:
  issues: write

jobs:
  clean-blocked-comments:
    runs-on: self-hosted
    steps:
      - name: Clean up 'Blocked by' references and manage issue status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const regex = /#(\d+)/g;

            const issues = await github.rest.issues.listForRepo({ owner, repo, state: 'open' });

            for (const issue of issues.data) {
              if (issue.pull_request) continue;

              console.log(`\nüîç Issue #${issue.number}: ${issue.title}`);
              
              const comments = await github.rest.issues.listComments({ owner, repo, issue_number: issue.number });
              let updated = false;

              for (const comment of comments.data) {
                if (!comment.body.toLowerCase().includes('blocked by')) continue;

                console.log(`üí¨ Comment ID: ${comment.id}`);
                console.log(`üìÑ Raw: ${JSON.stringify(comment.body)}`);

                const matches = [...comment.body.matchAll(regex)].map(m => parseInt(m[1]));
                const stillOpen = [];

                for (const ref of matches) {
                  try {
                    const refIssue = await github.rest.issues.get({ owner, repo, issue_number: ref });
                    if (refIssue.data.state === 'open') {
                      console.log(`üîó Found reference to issue #${ref}\n‚è≥ Issue #${ref} is still open.`);
                      stillOpen.push(`#${ref}`);
                    } else {
                      console.log(`üîó Found reference to issue #${ref}\n‚úÖ Issue #${ref} is closed.`);
                    }
                  } catch (err) {
                    console.warn(`‚ö†Ô∏è Issue #${ref} could not be fetched.`);
                  }
                }

                const newBody = stillOpen.length > 0
                  ? `Blocked by ${stillOpen.join(' ')}`
                  : '[Auto-removed blocked-by reference: all blocking issues closed.]';

                if (comment.body !== newBody) {
                  await github.rest.issues.updateComment({
                    owner,
                    repo,
                    comment_id: comment.id,
                    body: newBody
                  });
                  updated = true;
                  console.log(`‚úèÔ∏è Comment updated to: "${newBody}"`);
                } else {
                  console.log(`‚úÖ Comment is already correct. No update needed.`);
                }
              }

              // Manage issue status using labels
              const labels = issue.labels.map(l => l.name);
              const hasBlocked = comments.data.some(c => c.body.includes('Blocked by #') && !c.body.includes('Auto-removed'));

              if (hasBlocked && !labels.includes('Blocked')) {
                await github.rest.issues.addLabels({ owner, repo, issue_number: issue.number, labels: ['Blocked'] });
                console.log(`üè∑Ô∏è Label 'Blocked' added.`);
              } else if (!hasBlocked && labels.includes('Blocked')) {
                await github.rest.issues.setLabels({ owner, repo, issue_number: issue.number, labels: ['To-Do'] });
                console.log(`üö´ Label 'To-Do' added.`);
              }
            }

      - name: Run Pytest
        id: pytest
        run: |
          pytest || echo "Tests failed"
        continue-on-error: true  # Allow next steps to run even if tests fail

      - name: Label PR - Passed
        if: ${{ success() && github.event_name == 'pull_request' }}
        uses: actions-ecosystem/action-add-labels@v1
        with:
          labels: unit-test-passed

      - name: Remove Failed Label if Present
        if: ${{ success() && github.event_name == 'pull_request' }}
        uses: actions-ecosystem/action-remove-labels@v1
        with:
          labels: unit-test-failed

      - name: Label PR - Failed
        if: ${{ failure() && github.event_name == 'pull_request' }}
        uses: actions-ecosystem/action-add-labels@v1
        with:
          labels: unit-test-failed

      - name: Remove Passed Label if Present
        if: ${{ failure() && github.event_name == 'pull_request' }}
        uses: actions-ecosystem/action-remove-labels@v1
        with:
          labels: unit-test-passed

